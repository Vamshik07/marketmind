{% extends 'base.html' %}
{% block title %}Activity History{% endblock %}
{% block content %}
<div style="padding: 2rem; max-width: 1200px; margin: 0 auto;">
    <h1 style="margin-bottom: 0.5rem;"> Your Activity</h1>
    <p style="color: #666; margin-bottom: 2rem;">Campaign, Pitch, and Lead Score history</p>
    
    <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
        <input type="text" id="search-box" placeholder="Search..." style="flex: 1; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
        <button onclick="clearAllHistory()" style="padding: 0.75rem 1.5rem; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">Clear All</button>
    </div>
    <div id="history-list" style="background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"><div style="padding: 3rem; text-align: center; color: #999;">Loading...</div></div>
</div>

<!-- Modal for Full Content View -->
<div id="content-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; max-width: 800px; max-height: 80vh; overflow-y: auto; width: 90%; padding: 2rem; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <button onclick="closeModal()" style="position: absolute; top: 1rem; right: 1rem; background: #f0f0f0; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center;">√ó</button>
        <h2 id="modal-title" style="margin-top: 0; margin-bottom: 1.5rem; color: #223CCF;"></h2>
        <div id="modal-content" style="white-space: pre-wrap; line-height: 1.8; color: #333; font-size: 1rem; margin-bottom: 2rem;"></div>
        <div style="display: flex; gap: 1rem;">
            <button onclick="copyFromModal()" style="flex: 1; padding: 0.75rem 1.5rem; background: #0683D7; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">üìã Copy to Clipboard</button>
            <button onclick="downloadFromModal()" style="flex: 1; padding: 0.75rem 1.5rem; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">‚¨á Download as Text</button>
        </div>
    </div>
</div>

<style>
#content-modal {
    display: flex;
}
#content-modal[data-visible="false"] {
    display: none !important;
}
</style>

<script>
let allHistory = {};
let currentModalContent = '';
let currentModalTitle = '';

document.addEventListener('DOMContentLoaded', loadHistory);
document.getElementById('search-box').addEventListener('input', filterHistory);

async function loadHistory() {
    try {
        const resp = await fetch('/api/history/grouped');
        const json = await resp.json();
        if (!json.success) throw new Error(json.error);
        allHistory = json.data || {};
        filterHistory();
    } catch(err) {
        document.getElementById('history-list').innerHTML = '<div style="padding: 2rem; color: #dc3545;">Error: ' + err.message + '</div>';
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function toggleDetails(contentId, toggleId) {
    const content = document.getElementById(contentId);
    const toggle = document.getElementById(toggleId);
    if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.style.transform = 'rotate(90deg)';
    } else {
        content.style.display = 'none';
        toggle.style.transform = 'rotate(0deg)';
    }
}

function openModal(title, content) {
    currentModalTitle = title;
    currentModalContent = content;
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-content').textContent = content;
    const modal = document.getElementById('content-modal');
    modal.style.display = 'flex';
    modal.setAttribute('data-visible', 'true');
}

function closeModal() {
    const modal = document.getElementById('content-modal');
    modal.style.display = 'none';
    modal.setAttribute('data-visible', 'false');
}

function copyFromModal() {
    navigator.clipboard.writeText(currentModalContent).then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = '‚úì Copied!';
        setTimeout(() => {
            btn.textContent = originalText;
        }, 2000);
    }).catch(err => {
        alert('Failed to copy: ' + err.message);
    });
}

function downloadFromModal() {
    const element = document.createElement('a');
    const file = new Blob([currentModalContent], {type: 'text/plain'});
    element.href = URL.createObjectURL(file);
    element.download = currentModalTitle.replace(/\s+/g, '_') + '.txt';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
}

// Close modal when clicking outside
document.getElementById('content-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'content-modal') {
        closeModal();
    }
});

function filterHistory() {
    const search = document.getElementById('search-box').value.toLowerCase();
    const dates = ['Today', 'Yesterday', 'This week', 'Older'];
    let html = '';
    const hasItems = Object.values(allHistory).some(items => items.some(item => !search || JSON.stringify(item).toLowerCase().includes(search)));
    if (!hasItems) {
        document.getElementById('history-list').innerHTML = '<div style="padding: 2rem; text-align: center; color: #999;">No activity found</div>';
        return;
    }
    dates.forEach(date => {
        const items = (allHistory[date] || []).filter(item => !search || JSON.stringify(item).toLowerCase().includes(search));
        if (!items.length) return;
        html += '<div style="border-bottom: 1px solid #eee;"><div style="padding: 1rem 1.5rem; background: #f5f5f5; font-weight: 600; color: #666; font-size: 0.9rem;">' + date + '</div>';
        items.forEach(item => {
            const time = new Date(item.timestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            const icons = {'/campaign': 'üìã', '/pitch': 'üé§', '/lead-score': 'üë§'};
            const icon = icons[item.page_url] || '';
            const toggleId = 'toggle-' + item.id;
            const contentId = 'content-' + item.id;
            
            html += '<div style="padding: 1rem 1.5rem; border-bottom: 1px solid #f0f0f0; background: white;">';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleDetails(\'' + contentId + '\', \'' + toggleId + '\')">';
            html += '<div style="display: flex; align-items: center; gap: 1rem; flex: 1;">';
            html += '<span style="font-size: 1.5rem;">' + icon + '</span>';
            html += '<div>';
            html += '<strong>' + item.page_title + '</strong><br><small style="color: #999;">' + time + '</small>';
            html += '</div>';
            html += '</div>';
            html += '<span id="' + toggleId + '" style="font-size: 1.2rem; color: #999; transition: transform 0.2s;">‚ñ∂</span>';
            html += '</div>';
            
            // Details section (expandable)
            html += '<div id="' + contentId + '" style="display: none; padding: 1rem 0; border-top: 1px solid #f0f0f0; margin-top: 1rem;">';
            
            // Show input data and result from metadata
            if (item.metadata) {
                html += '<div style="background: #f9f9f9; padding: 1rem; border-radius: 6px; font-size: 0.95rem;">';
                
                // Campaign
                if (item.action_type === 'campaign_generated' && item.metadata.product) {
                    html += '<div><strong>Product:</strong> ' + escapeHtml(item.metadata.product) + '</div>';
                    html += '<div style="margin-top: 0.5rem;"><strong>Audience:</strong> ' + escapeHtml(item.metadata.audience) + '</div>';
                    html += '<div style="margin-top: 0.5rem;"><strong>Platform:</strong> ' + escapeHtml(item.metadata.platform) + '</div>';
                    if (item.metadata.result) {
                        html += '<hr style="margin: 1rem 0; border: none; border-top: 1px solid #ddd;">';
                        html += '<div style="background: #e8f5e9; padding: 1rem; border-radius: 6px; border-left: 4px solid #27ae60;">';
                        html += '<strong style="color: #27ae60;">üìã Generated Campaign</strong>';
                        html += '<div style="margin-top: 0.75rem; max-height: 300px; overflow-y: auto; white-space: pre-wrap; line-height: 1.6; color: #333;">' + escapeHtml(item.metadata.result) + '</div>';
                        html += '<button onclick="openModal(\'Campaign Output\', ' + JSON.stringify(item.metadata.result) + ')" style="margin-top: 0.75rem; padding: 0.5rem 1rem; background: #0683D7; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; margin-right: 0.5rem;">üëÅ View Full</button>';
                        html += '<button onclick="copyToClipboard(' + JSON.stringify(item.metadata.result) + ')" style="margin-top: 0.75rem; padding: 0.5rem 1rem; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">üìã Copy</button>';
                        html += '</div>';
                    }
                }
                
                // Pitch
                else if (item.action_type === 'pitch_generated' && item.metadata.product) {
                    html += '<div><strong>Product:</strong> ' + escapeHtml(item.metadata.product) + '</div>';
                    html += '<div style="margin-top: 0.5rem;"><strong>Persona:</strong> ' + escapeHtml(item.metadata.persona) + '</div>';
                    if (item.metadata.result) {
                        html += '<hr style="margin: 1rem 0; border: none; border-top: 1px solid #ddd;">';
                        html += '<div style="background: #f3e5f5; padding: 1rem; border-radius: 6px; border-left: 4px solid #8D3FD0;">';
                        html += '<strong style="color: #8D3FD0;">üé§ Generated Pitch</strong>';
                        html += '<div style="margin-top: 0.75rem; max-height: 300px; overflow-y: auto; white-space: pre-wrap; line-height: 1.6; color: #333;">' + escapeHtml(item.metadata.result) + '</div>';
                        html += '<button onclick="openModal(\'Pitch Output\', ' + JSON.stringify(item.metadata.result) + ')" style="margin-top: 0.75rem; padding: 0.5rem 1rem; background: #0683D7; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; margin-right: 0.5rem;">üëÅ View Full</button>';
                        html += '<button onclick="copyToClipboard(' + JSON.stringify(item.metadata.result) + ')" style="margin-top: 0.75rem; padding: 0.5rem 1rem; background: #8D3FD0; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">üìã Copy</button>';
                        html += '</div>';
                    }
                }
                
                // Lead Score
                else if (item.action_type === 'lead_scored' && item.metadata.name) {
                    html += '<div><strong>Name:</strong> ' + escapeHtml(item.metadata.name) + '</div>';
                    html += '<div style="margin-top: 0.5rem;"><strong>Budget:</strong> ' + escapeHtml(item.metadata.budget) + '</div>';
                    html += '<div style="margin-top: 0.5rem;"><strong>Need:</strong> ' + escapeHtml(item.metadata.need) + '</div>';
                    html += '<div style="margin-top: 0.5rem;"><strong>Urgency:</strong> ' + escapeHtml(item.metadata.urgency) + '</div>';
                    if (item.metadata.result) {
                        html += '<hr style="margin: 1rem 0; border: none; border-top: 1px solid #ddd;">';
                        html += '<div style="background: #e3f2fd; padding: 1rem; border-radius: 6px; border-left: 4px solid #0683D7;">';
                        html += '<strong style="color: #0683D7;">üë§ Lead Score Result</strong>';
                        html += '<div style="margin-top: 0.75rem; max-height: 300px; overflow-y: auto; white-space: pre-wrap; line-height: 1.6; color: #333;">' + escapeHtml(item.metadata.result) + '</div>';
                        html += '<button onclick="openModal(\'Lead Score Output\', ' + JSON.stringify(item.metadata.result) + ')" style="margin-top: 0.75rem; padding: 0.5rem 1rem; background: #0683D7; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; margin-right: 0.5rem;">üëÅ View Full</button>';
                        html += '<button onclick="copyToClipboard(' + JSON.stringify(item.metadata.result) + ')" style="margin-top: 0.75rem; padding: 0.5rem 1rem; background: #0683D7; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">üìã Copy</button>';
                        html += '</div>';
                    }
                }
                
                html += '</div>';
            }
            
            html += '<div style="margin-top: 1rem;">';
            html += '<button onclick="deleteItem(' + item.id + ')" style="padding: 0.5rem 1rem; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">üóë Delete</button>';
            html += '</div>';
            html += '</div>';
            
            html += '</div>';
        });
        html += '</div>';
    });
    document.getElementById('history-list').innerHTML = html;
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = '‚úì Copied!';
        btn.style.background = '#27ae60';
        setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = btn.id ? btn.style.background : '#0683D7';
        }, 2000);
    }).catch(err => {
        alert('Failed to copy: ' + err.message);
    });
}

async function deleteItem(id) {
    if (!confirm('Delete?')) return;
    try {
        await fetch('/api/history/delete/' + id, {method: 'DELETE'});
        loadHistory();
    } catch(err) {
        alert('Error: ' + err.message);
    }
}

async function clearAllHistory() {
    if (!confirm('Clear ALL activity?')) return;
    try {
        await fetch('/api/history/clear', {method: 'DELETE'});
        loadHistory();
    } catch(err) {
        alert('Error: ' + err.message);
    }
}
</script>
</script>
{% endblock %}